<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Surah - baca.quran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .loader {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"
  >
    <!-- Navbar -->
    <nav class="w-full bg-white shadow-md py-4">
      <div class="container mx-auto flex justify-between items-center px-6">
        <a href="#" class="text-2xl font-bold">baca.quran</a>
        <div class="flex space-x-5">
          <a href="/" class="text-gray-700 hover:text-blue-500">Home</a>
          <a href="/surah" class="text-gray-700 hover:text-blue-500">Surah</a>
          <a
            href="/profile"
            id="profile-link"
            class="text-gray-700 hover:text-blue-500 hidden"
            >Profile</a
          >
        </div>
      </div>
    </nav>

    <section class="flex flex-col items-center justify-start py-8">
      <h1 id="surah-title" class="text-4xl font-bold text-white mb-6"></h1>
      <div id="loader" class="loader"></div>
      <div
        id="ayah-list"
        class="bg-white rounded-lg shadow-lg p-6 w-full max-w-3xl"
      >
        <!-- Daftar ayat akan dimuat di sini secara dinamis -->
      </div>
    </section>

    <script>
      async function fetchSurahDetails() {
        const loader = document.getElementById('loader');
        const ayahListContainer = document.getElementById('ayah-list');
        loader.style.display = 'block';
        ayahListContainer.classList.add('hidden');

        try {
          let surah;
          let surahTranslation;

          const urlParams = new URLSearchParams(window.location.search);
          const number = urlParams.get('number');

          // Check if data is in local storage
          const cachedSurah = localStorage.getItem(`surah_${number}`);
          const cachedSurahTranslation = localStorage.getItem(
            `surah_translation_${number}`
          );

          if (cachedSurah && cachedSurahTranslation) {
            // Parse the cached data
            surah = JSON.parse(cachedSurah);
            surahTranslation = JSON.parse(cachedSurahTranslation);

            // console.log('get from cache');
          } else {
            // Fetch data from API if not in cache
            const responseSurah = await fetch(
              `http://localhost:3000/surah/${number}`
            );

            // const responseSurah = await fetch(`https://api.alquran.cloud/v1/surah/${number}/ar.alafasy`);
            surah = await responseSurah.json();
            // const responseSurahTranslation = await fetch(
            //   `https://api.alquran.cloud/v1/surah/${number}/en.asad`
            // );

            // surahTranslation = await responseSurahTranslation.json();

            // Save the fetched data to local storage
            localStorage.setItem(`surah_${number}`, JSON.stringify(surah));
            // localStorage.setItem(
            //   `surah_translation_${number}`,
            //   JSON.stringify(surahTranslation)
            // );
            // console.log('get from api, save to local');
          }

          const surahTitle = document.getElementById('surah-title');
          surahTitle.textContent = `${surah.data.number}. ${surah.data.englishName}`;

          const ayahListContainer = document.getElementById('ayah-list');
          const ayahList = document.createElement('ul');
          ayahList.classList.add('divide-y', 'divide-gray-300');

          const favoriteAyahs =
            JSON.parse(localStorage.getItem('favoriteAyahs')) || [];
          const checkpoints =
            JSON.parse(localStorage.getItem('checkpoints')) || [];

          surah.data.ayahs.forEach((ayah) => {
            const isFavorite = favoriteAyahs.some(
              (fav) =>
                fav.surahNumber === surah.data.number &&
                fav.ayahNumber === ayah.nomorAyat
            );
            const isCheckpointed =
              surah.data.number == checkpoints.surahNumber &&
              ayah.nomorAyat == checkpoints.ayahNumber
                ? true
                : false;

            console.log({
              test: surah.data.number,
              data: favoriteAyahs,
            });

            ayahList.insertAdjacentHTML(
              'beforeend',
              `
                        <li class="py-4">
                            <div class="flex justify-between items-center py-4">
                                <div class="font-bold pr-5">${
                                  ayah.nomorAyat
                                }.</div>
                                <div class="text-2xl text-right font-bold">${
                                  ayah.teksArab
                                }</div>
                            </div>
                            <div class="text-sm font-normal">
                                <p class="mb-2">
                                    ${ayah.teksIndonesia}
                                </p>
                                <div class="flex items-center gap-2">
                                    <span class="play-icon" title="Play audio" onclick="toggleAudio('${
                                      ayah.audio['01']
                                    }', this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-green-500" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M5 4v12l10-6-10-6z" stroke="currentColor" />
                                        </svg>
                                    </span>
                                    <span class="save-icon" title="Save to favorite" onclick="toggleFavorite(this, ${
                                      surah.data.number
                                    }, ${ayah.nomorAyat}, '${
                ayah.teksArab
              }', '${ayah.teksIndonesia}')">
                                        ${
                                          isFavorite
                                            ? `
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-yellow-500" viewBox="0 0 27 27" fill="currentColor">
                                                <path d="M19 21l-7-5.01L5 21V5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v16z"/>
                                            </svg>
                                        `
                                            : `
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-gray-500" viewBox="0 0 27 27" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M19 21l-7-5.01L5 21V5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v16z"/>
                                            </svg>
                                        `
                                        }
                                    </span>
                                    <span class="checkpoint-icon" onclick="toggleCheckpoint(this, ${
                                      surah.data.number
                                    }, ${ayah.nomorAyat})">
                                        ${
                                          isCheckpointed
                                            ? `
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer" viewBox="0 0 27 27" fill="none">
                                                <path d="M16 3.93552C14.795 3.33671 13.4368 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 11.662 20.9814 11.3283 20.9451 11M21 5L12 14L9 11" stroke="#16a74a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>

                                        `
                                            : `
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer" viewBox="0 0 27 27" fill="none">
                                                <path d="M16 3.93552C14.795 3.33671 13.4368 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 11.662 20.9814 11.3283 20.9451 11M21 5L12 14L9 11" stroke="grey" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        `
                                        }
                                    </span>
                                </div>
                            </div>
                        </li>
                    `
            );
          });

          ayahListContainer.appendChild(ayahList);
        } catch (error) {
          console.error('Error fetching surah details:', error);
        } finally {
          loader.style.display = 'none';
          ayahListContainer.classList.remove('hidden');
        }
      }

      let currentAudio = null;

      function toggleAudio(audioUrl, iconElement) {
        if (currentAudio && !currentAudio.paused) {
          currentAudio.pause();
          document.querySelector('.pause-icon').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M5 4v12l10-6-10-6z" />
                    </svg>
                `;
          currentAudio = null;
        } else {
          currentAudio = new Audio(audioUrl);
          currentAudio.play();
          iconElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-red-500 pause-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M6 4h2v12H6zM12 4h2v12h-2z" />
                    </svg>
                `;

          currentAudio.addEventListener('ended', function () {
            iconElement.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5 4v12l10-6-10-6z" />
                        </svg>
                    `;
            currentAudio = null;
          });
        }
      }

      function toggleFavorite(
        iconElement,
        surahNumber,
        ayahNumber,
        arabicText,
        translationText
      ) {
        let favoriteAyahs =
          JSON.parse(localStorage.getItem('favoriteAyahs')) || [];
        const ayahIndex = favoriteAyahs.findIndex(
          (fav) =>
            fav.surahNumber === surahNumber && fav.ayahNumber === ayahNumber
        );

        if (ayahIndex > -1) {
          // Remove from favorites
          favoriteAyahs.splice(ayahIndex, 1);
          iconElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-gray-500" viewBox="0 0 27 27" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21l-7-5.01L5 21V5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v16z"/>
                    </svg>
                `;
        } else {
          // Add to favorites
          favoriteAyahs.push({
            surahNumber,
            ayahNumber,
            arabicText,
            translationText,
          });
          iconElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer text-yellow-500" viewBox="0 0 27 27" fill="currentColor">
                        <path d="M19 21l-7-5.01L5 21V5c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v16z"/>
                    </svg>
                `;
        }

        localStorage.setItem('favoriteAyahs', JSON.stringify(favoriteAyahs));
      }

      function toggleCheckpoint(iconElement, surahNumber, ayahNumber) {
        let checkpoints = {};

        // Remove checkpoint
        checkpoints.surahNumber = surahNumber;
        checkpoints.ayahNumber = ayahNumber;

        const elements = document.querySelectorAll(
          'svg path[stroke="#16a74a"]'
        );
        elements.forEach((element) => {
          console.log(element); // Contoh: menampilkan elemen di console
          // Ubah warna outline menjadi abu-abu
          element.setAttribute('stroke', 'grey');
        });

        iconElement.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer" viewBox="0 0 27 27" fill="none">
                    <path d="M16 3.93552C14.795 3.33671 13.4368 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 11.662 20.9814 11.3283 20.9451 11M21 5L12 14L9 11" stroke="#16a74a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;

        localStorage.setItem('checkpoints', JSON.stringify(checkpoints));
      }

      async function fetchProfile() {
        // Placeholder for fetching and displaying user profile information
        // Implementation can vary based on backend or user authentication system
        // For simplicity, this function can retrieve data from localStorage or another API
        // to display user's last read checkpoint and favorite ayahs
      }

      fetchSurahDetails();
    </script>
  </body>
</html>
